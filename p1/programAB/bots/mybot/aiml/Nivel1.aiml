<?xml version="1.0" encoding="UTF-8"?>
<aiml version="2.0">

<!-- Tareas pendientes para la práctica: 
- Ya dice la horas libres, que recuerde por dónde va para la respuesta del cliente <set name="HORAS_DISPONBLES"> es la variable global que las contiene
<set name=FECHA> fecha en la que se está trabajando
 -->
<category> 
<pattern>cita * </pattern>
<template>
  <think>
  <!-- Pasa a una lista una fecha concreta con formato 10-12-20 -->
  <set var="horas"><map name="eventos"><star/></map></set>
  <set name="FECHA"><star/></set>
  
  Estas son las horas de trabajo libre:

<!-- Falla el sublist por algún motivo -->  
  <set var="horaTrabajo">
    <srai> SUBLIST FROM 9 TO 21 OF <get var="horas"/> </srai>
  </set>
    <!-- Busca si hay alguna libre 26-02-20 y 27 ocupadas -->
  <set var="pos">
    <srai>FINDITEM null IN  <get var="horaTrabajo"/></srai>
  </set>


  </think>
  <condition var="pos">
    <li value="0"> Pues esta todo acupado, lo siento desea otro dia
    </li>
    <li>  Parece que hay hueco para ese dia
    <srai>INDICE null EN <get var="horaTrabajo"/></srai>
    <think>
      indicamos que se espera que se diga algo sobre las horas mencionamos
      <set name="topic">RESPUESTA_HORAS</set>
    </think>
    </li>
  </condition>
  
</template>
</category>

<!-- Funciones auxiliares -->

<!-- Lista con posiciones del segundo elemento -->
<category> 
  <pattern>indice * en *</pattern>
  
  <template>
    <think>
    valor de la lista: 
    <set var="lista"><star index="2"/></set>
    <set var="listaHoras">08:00 09:00 10:00 11:00 12:00 13:00 14:00 15:00 16:00 17:00 18:00 19:00 20:00</set>
    <set var="numeroIncidencias">1</set>
      

    Guardamos el caso inicial en un indice, sabemos que existe, su valor es:
    <set var="pos"> 
	  <srai>FINDITEM <star index="1"/> IN <get var="lista"/></srai>
    </set>
    
    <set var="salida">
      <srai>SELECTITEM <get var="pos"/> IN <get var="listaHoras"/></srai>
    </set>
    Eliminamos el caso anterior de la lista y su hora asociada
    <set var="lista">
      <srai> SUBLIST FROM <map name="successor"><get var="pos"/></map> TO 24 OF <get var="lista"/></srai>
    </set>
    <set var="listaHoras">
      <srai> SUBLIST FROM <map name="successor"><get var="pos"/></map> TO 24 OF <get var="listaHoras"/></srai>
    </set>
    <set var="pos">
      <srai>FINDITEM <star index="1"/> IN  <get var="lista"/></srai>
    </set>

    </think>

  <condition var="pos">
    <li value="0">
      Las horas disponibles son: <set name="HORAS_DISPONBLES"><get var="salida"/></set></li>
    <li>
      <think>
      Quedan indices por buscar
      Anadimos el nuevo a la lista
      <set var="nuevaHora">
	<srai>SELECTITEM <get var="pos"/> IN <get var="listaHoras"/></srai>
      </set>
     
      <set var="salida">
	<srai>
	  ADDITEM <get var="nuevaHora"/> IN <get var="salida"/>
	</srai>
      </set>
      Eliminamos el caso anterior de la lista y su hora asociada
      <set var="lista">
	<srai> SUBLIST FROM <map name="successor"><get var="pos"/></map> TO 24 OF <get var="lista"/></srai>
      </set>
      <set var="listaHoras">
	<srai> SUBLIST FROM <map name="successor"><get var="pos"/></map> TO 24 OF <get var="listaHoras"/></srai>
      </set>
      <set var="pos">
	<srai>FINDITEM <star index="1"/> IN  <get var="lista"/></srai>
      </set>
      <set var="numeroIncidencias">
	<map name="successor"><get var="numeroIncidencias"/></map>
      </set>
      </think>
      <loop/>
    </li>
  </condition>
  
  </template>
</category>




<!-- RESPUESTAS POSIBLES TRAS DECIR LAS HORAS topic "RESPUESTA HORAS" -->
<topic name="RESPUESTA_HORAS">
  <category> 
    <pattern>HORA <set>hora_simple</set></pattern>
    <template>
      Comprobamos si esa hora esta definida en nuetra lista

      <set var="pos"> 
	  <srai>FINDITEM <star/>:00 IN <get name="HORAS_DISPONBLES"/></srai>
      </set>
      <condition var="pos">
	<li value="0">Lo siento, esa hora no esta libre, las disponibles son <get name="HORAS_DISPONBLES"/></li>
	<li>
	  Muy bien, procedo a reservarle la hora

	  <srai>MARK OCUPADO AT <star/>:00 ON <get name="FECHA"/></srai>
	  
	  <set name="topic">null</set>
	  
	</li>
      </condition>
    

      
    </template>
  </category>

  
</topic>


</aiml>

